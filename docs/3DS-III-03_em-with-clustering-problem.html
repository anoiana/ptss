<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Thuật Toán Expectation-Maximization (EM) (3/3)</title>

<script src="site_libs/header-attrs-2.5/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="img/fugu.png"/>

<div class="hero-image">
        <div class="image-text">
          <div class="top-text"> </div>
            <div class="bottom-text"> </div>
        </div>
</div>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ANOIANA</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bookmark"></span>
     
    Readings
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">I. SURVIVAL ANALYSIS</li>
    <li>
      <a href="2READ-1SUV-01_nonparametrics-homogeneous-pop.html">1. Non-parametric procedures for homogeneous population</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">II. OTHER TOPICS</li>
    <li>
      <a href="2READ-2OTHER-01_lim-inf-lim-sup.html">1. Limit of Supremum and Infimum</a>
    </li>
    <li>
      <a href="2READ-2OTHER-02_proof-of-maic.html">2. Why does optimization of MAIC method turn out to be fitting logistic model?</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">III. BAYESIAN ANALYSIS</li>
    <li>
      <a href="2READ-3BAY-01_intro-to-bayes.html">1. Introduction to Bayesian analysis</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bookmark"></span>
     
    Đọc sách
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">I. PHÂN TÍCH SỐNG SÓT</li>
    <li>
      <a href="3DS-I-01_ly-thuyet-toan-cho-phan-tich-song-sot.html">1. lý thuyết toán trong phân tích sống sót</a>
    </li>
    <li>
      <a href="3DS-I-02_phuong-phap-phi-tham-so.html">2. Phương pháp phi tham số</a>
    </li>
    <li>
      <a href="3DS-I-03_so-sanh-2-mau-phi-tham-so.html">3. So sánh 2 mẫu với phương pháp phi tham số</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">III. CÁC CHỦ ĐỀ RIÊNG</li>
    <li>
      <a href="3DS-III-01_em-algorithm.html">1. Thuật toán Expectation-Maximization (EM) [1/3]</a>
    </li>
    <li>
      <a href="3DS-III-02_mle-va-em.html">2. Thuật toán Expectation-Maximization (EM) [2/3]</a>
    </li>
    <li>
      <a href="3DS-III-03_em-with-clustering-problem.html">3. Thuật toán Expectation-Maximization (EM) [3/3]</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Thuật Toán Expectation-Maximization (EM) (3/3)</h1>
<h3 class="subtitle">Phần III - Bài Toán Phân Cụm</h3>
<h4 class="date">📅 2021-05-12</h4>

</div>


<hr />
<div id="đặt-vấn-đề" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Đặt vấn đề</h1>
<p>Ta lại tiếp tục xem xét một dạng bài thuộc nhóm phân cụm trong machine learning, và bài này sẽ được giải bằng phương pháp EM. Ta nhắc lại cấu trúc bài toán “hai đồng xu” trong bài số 1 lần trước. Trong bài toán “hai đồng xu” ta xem xét trường hợp khi ta phải chọn 2 đồng xu, mỗi đồng xu có xác suất mặt hình không giống nhau. Ta ngẫu nhiên chọn ra 1 đồng xu rồi tung đồng xu 5 lần, ta lập lại 2 bước trên 10 lần.Như vậy ta thấy rằng mỗi một đổng xu đại diện cho 1 nhóm, tạm gọi là A và B. khi một đồng xu được chọn và tung 5 lần, ta có một phân bố nhị thức với parameters của nó là <span class="math inline">\(5\)</span> và <span class="math inline">\(p_i\)</span>, với <span class="math inline">\(i \in \{A,B\}\)</span>. Nghĩa là ta có <span class="math inline">\(\Bbb{P}(X|A)\)</span> và <span class="math inline">\(\Bbb{P}(X|B)\)</span> đều là phân bố nhị thức, nghĩa là <span class="math inline">\(X|A \sim \mathcal{Bin}(5,p_A)\)</span> và <span class="math inline">\(X|B \sim \mathcal{Bin}(5,p_B)\)</span>. Ngoài ra, ta cũng được cung cấp một thông tin rằng đồng xu <span class="math inline">\(A\)</span> được chọn với xác suất là là <span class="math inline">\(\pi_A\)</span>, như vậy xác suất để đồng xu B được chọn là <span class="math inline">\(1-\pi_A\)</span>. Rõ ràng, hành động chọn đồng xu A hoặc B lại là một phân bố bernoulli với parameter của nó là <span class="math inline">\(\pi_A\)</span>, nghĩa là <span class="math inline">\(Z \sim \mathcal{Bin}(1,\pi_A)\)</span>. Với dạng bài này, ta gọi là phân bố hỗn hợp, vì nó kết hợp giữa 2 phân bố nhị thức bằng một phân bố bernoulli (bernoulli cũng là phân bố nhị thức với parameter <span class="math inline">\(n =1\)</span>).</p>
<p>Lần này ta cũng xét một bài tương tự. Với một tập dữ liệu <span class="math inline">\(X\)</span> có chiều không gian <span class="math inline">\(n\times p\)</span> và một biến target <span class="math inline">\(y \in \{1,2,3\}^{n}\)</span>. Nếu giả định ban đầu mỗi một hàng trong tập dữ liệu <span class="math inline">\(X\)</span> thuộc một phân bố multivariate normal, và <span class="math inline">\(X\)</span> bao gồm các quan sát thuộc 3 phân bố multiviriate normal khác nhau, thì đây cũng là một dạng bài phân bố hỗn hợp. Nhưng lần này là 3 phân bố multivariate normal được kết hợp bằng một phân bố tam thức <span class="math inline">\(Z \sim Trinomial(n,p_1,p_2)\)</span>.</p>
</div>
<div id="data-giả-lập" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Data giả lập</h1>
<p>Đầu tiên ta sẽ tạo một data có dạng như sau. Ta sẽ tạo ra một tập dữ liệu bao gồm 360 observations, với mỗi observation thuộc một trong ba phân bố binormal:
<span class="math display">\[
\begin{aligned}
&amp;f(x|z_1) \sim BN\bigg(\begin{bmatrix}4\\4\end{bmatrix}, \begin{bmatrix}0.25 &amp; 0.21\\ 0.21 &amp; 0.25\end{bmatrix}\bigg); \\
&amp;f(x|z_2) \sim BN\bigg(\begin{bmatrix}5\\5\end{bmatrix}, \begin{bmatrix}0.25 &amp; -0.21\\ -0.21 &amp; 0.25\end{bmatrix}\bigg); \\
&amp;f(x|z_3) \sim BN\bigg(\begin{bmatrix}6.5\\5\end{bmatrix}, \begin{bmatrix}0.25 &amp; 0.21\\ 0.21 &amp; 0.25\end{bmatrix}\bigg)
\end{aligned}
\]</span>
vói <span class="math inline">\(Z \sim Trinomial(360,0.2,0.5)\)</span>, trong thực tế các giá trị này sẽ không được biết, và nhiệm vụ của ta là ước lượng những giá trị này.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">360</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">4.0</span>,<span class="fl">4.0</span>, <span class="fl">5.0</span>,<span class="fl">5.0</span>,<span class="fl">6.5</span>,<span class="fl">5.0</span>), <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">byrow=</span>T)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">~</span>mu[.,])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sig<span class="ot">&lt;-</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">list</span>(<span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">21</span>, .<span class="dv">21</span>,.<span class="dv">25</span>), </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(.<span class="dv">25</span>,<span class="sc">-</span>.<span class="dv">21</span>,<span class="sc">-</span>.<span class="dv">21</span>,.<span class="dv">25</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">21</span>, .<span class="dv">21</span>,.<span class="dv">25</span>)),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a> matrix, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.5</span>,<span class="fl">0.3</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,n, <span class="at">replace =</span> T, <span class="at">prob =</span> p )</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">111</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>dat<span class="ot">&lt;-</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map</span>(y, <span class="sc">~</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> mu[[.]], <span class="at">Sigma=</span>sig[[.]]))<span class="sc">%&gt;%</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a> <span class="fu">reduce</span>(rbind)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>color <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;black&quot;</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat, <span class="at">col =</span> color[y], <span class="at">xlab =</span> <span class="st">&quot;x1&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;x2&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-1"></span>
<img src="3DS-III-03_em-with-clustering-problem_files/figure-html/unnamed-chunk-1-1.png" alt="*Dữ liệu X nếu thông tin từ Z được cung cấp*" width="672" />
<p class="caption">
Figure 2.1: <em>Dữ liệu X nếu thông tin từ Z được cung cấp</em>
</p>
</div>
<p>như vậy, nếu phân bố của <span class="math inline">\(Z\)</span> không được biết thì tập giá trị ta có như sau</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-2"></span>
<img src="3DS-III-03_em-with-clustering-problem_files/figure-html/unnamed-chunk-2-1.png" alt="*Dữ liệu X khi thông tin của Z không được cung cấp.*" width="672" />
<p class="caption">
Figure 2.2: <em>Dữ liệu X khi thông tin của Z không được cung cấp.</em>
</p>
</div>
<p>Mục tiêu của ta là sẽ đi phân cụm cho tập dữ liệu này.</p>
</div>
<div id="phân-cụm-bằng-phương-pháp-em" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Phân cụm bằng phương pháp EM</h1>
<p>Mỗi một quan sát sẽ có xác suất là <span class="math inline">\(\pi_k\mathcal{N}(\boldsymbol{\mu}_k,\boldsymbol{\Sigma}_k)\)</span>, như vậy ta sẽ có phương trình likelihood là
<span class="math display">\[
L(\theta) = \prod_{i=1}^N\prod_{k=1}^K[\pi_k\mathcal{N}(\boldsymbol{\mu}_k,\boldsymbol{\Sigma}_k)]^{z_{ik}}
\]</span>
và suy ra hàm log-likelihood
<span class="math display" id="eq:eq1">\[
l(\theta) = \sum_{i =1}^N\sum_{k=1}^Kz_{ik}[\ln\pi_k+\ln\mathcal{N}(\boldsymbol{\mu}_k, \boldsymbol{\Sigma}_k)]
\tag{3.1}
\]</span></p>
<p><strong>Trong bước E</strong>, ta sẽ xác định <span class="math inline">\(\Bbb{E}[l(\theta)]\)</span>:
<span class="math display">\[
\Bbb{E}[l(\theta)] = \sum_{i =1}^N\sum_{k=1}^K\gamma(z_{ik})[\ln\pi_k+\ln\mathcal{N}(\boldsymbol{\mu}_k,\boldsymbol{\Sigma}_k)]
\]</span>
Trong đó
<span class="math display" id="eq:eq2">\[
\gamma(z_{ik}) = \frac{\pi_k\mathcal{N}(\boldsymbol{x}_i|\boldsymbol{\mu}_k,\boldsymbol{\Sigma}_k)}{\sum_{k=1}^K\pi_k\mathcal{N}(\boldsymbol{x}_i|\boldsymbol{\mu}_k,\boldsymbol{\Sigma}_k)}
\tag{3.2}
\]</span>
<strong>Trong bước M</strong>, ta lấy đạo hàm <span style="color: #424242; font-size: 18px;"><em>Eq.</em></span> <a href="#eq:eq1">(3.1)</a> theo biến <span class="math inline">\(\boldsymbol{\mu}_k\)</span>, <span class="math inline">\(\boldsymbol{\Sigma}_k\)</span> và <span class="math inline">\(\pi_k\)</span>, cho đạo hàm bằng 0, ta sẽ có
<span class="math display" id="eq:eq3">\[
\begin{aligned}
\boldsymbol{\mu}_k &amp;= \frac{\sum_{i=1}^N\gamma(z_{ik})\boldsymbol{x}_i}{\sum_{i=1}^N\gamma(z_{ik})} \\
\boldsymbol{\Sigma}_k &amp;= \frac{\sum_{i=1}^N\gamma(z_{ik})(\boldsymbol{x}_i-\boldsymbol{\mu}_k){(\boldsymbol{x}_i-\boldsymbol{\mu}_k)}^{\top}}{\sum_{i=1}^N\gamma(z_{ik})} \\
\pi_k &amp;= \frac{\sum_{i=1}^N\gamma(z_{ik})}{N}
\end{aligned} 
\tag{3.3}
\]</span></p>
<p>Sử dụng <span style="color: #424242; font-size: 18px;"><em>Eq.</em></span> <a href="#eq:eq2">(3.2)</a> và <span style="color: #424242; font-size: 18px;"><em>Eq.</em></span> <a href="#eq:eq3">(3.3)</a> để viết <code>R code</code> như bên dưới</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(dat) <span class="co"># number of dimensions</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat) <span class="co"># number of samples</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>K<span class="ot">=</span><span class="dv">3</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ranges <span class="ot">&lt;-</span> <span class="fu">apply</span>(dat, <span class="dv">2</span>, range) <span class="co"># the ranges for each dimension</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>pik <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>K,K)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>muk <span class="ot">=</span> <span class="fu">apply</span>(ranges,<span class="dv">2</span>, <span class="cf">function</span>(i) <span class="fu">runif</span>(<span class="dv">3</span>,i[<span class="dv">1</span>],i[<span class="dv">2</span>]))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>muk <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="cf">function</span>(i) muk[i,])</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Sigmas <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="cf">function</span>(i) <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># EM steps</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>gammak<span class="ot">&lt;-</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">pmap</span>(<span class="fu">list</span>(pik,muk,Sigmas), <span class="sc">~</span>{</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">apply</span>(dat,<span class="dv">1</span>, <span class="cf">function</span>(i) ..<span class="dv">1</span><span class="sc">*</span><span class="fu">dmvnorm</span>(i,..<span class="dv">2</span>,..<span class="dv">3</span>) )</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>})<span class="sc">%&gt;%</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(<span class="sc">~</span> <span class="fu">c</span>(...)<span class="sc">%&gt;%</span>{.<span class="sc">/</span><span class="fu">sum</span>(.)})<span class="sc">%&gt;%</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">reduce</span>(rbind)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># M step</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>pik<span class="ot">&lt;-</span><span class="fu">t</span>(gammak)<span class="sc">%*%</span><span class="fu">rep</span>(<span class="dv">1</span>,N)<span class="sc">/</span>N</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>muk <span class="ot">=</span> <span class="fu">apply</span>(gammak,<span class="dv">2</span>, <span class="cf">function</span>(i) <span class="fu">t</span>(dat)<span class="sc">%*%</span>i<span class="sc">/</span><span class="fu">sum</span>(i) )<span class="sc">%&gt;%</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a> {<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="cf">function</span>(i) .[,i] )}</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>gammak <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(gammak), <span class="cf">function</span>(i) gammak[,i] )</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>Sigmas<span class="ot">&lt;-</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">pmap</span>(<span class="fu">list</span>(muk, gammak), <span class="sc">~</span>{</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a> m <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">apply</span>(dat,<span class="dv">1</span>, <span class="cf">function</span>(j) (j<span class="sc">-</span>..<span class="dv">1</span>)))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(m), <span class="cf">function</span>(i) m[i,]<span class="sc">%*%</span><span class="fu">t</span>(m[i,])<span class="sc">*</span>..<span class="dv">2</span>[i]<span class="sc">/</span><span class="fu">sum</span>(..<span class="dv">2</span>))<span class="sc">%&gt;%</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">reduce</span>(gammak,cbind)<span class="sc">%&gt;%</span><span class="fu">apply</span>(<span class="dv">1</span>, which.max)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># #create animated images</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># f = function()  plot(dat, col = pred, main = paste0(iter))</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># k = ggplotify::as.ggplot(f)</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co"># if(!dir.exists(&quot;_supp/myfolder&quot;)) dir.create(&quot;_supp/myfolder&quot;)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(plot = f, filename =  paste0(&quot;_supp/myfolder/&quot;,iter,&quot;.png&quot;), device = &quot;png&quot;)</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ## list file names and read in</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co"># imgs &lt;- list.files(&quot;_supp/myfolder&quot;, full.names = TRUE)</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co"># img_list &lt;- lapply(imgs, magick::image_read)</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># ## join the images together</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="co"># img_joined &lt;- magick::image_join(img_list)</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="co"># ## animate at 2 frames per second</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># img_animated &lt;- magick::image_animate(img_joined, fps = 1)</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ## save to disk</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co"># magick::image_write(image = img_animated,</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co">#             path = &quot;_supp/img/img1.gif&quot;)</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="co"># unlink(&quot;_supp/myfolder&quot;, recursive = TRUE)</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">table</span>(pred))</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">table</span>(y))</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">names</span>(b2)<span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>(), <span class="fu">names</span>(b1)<span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>())</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">sapply</span>(y, <span class="cf">function</span>(i)  a[<span class="fu">match</span>(i,a[,<span class="dv">1</span>]),<span class="dv">2</span>])</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>confu <span class="ot">=</span> <span class="fu">table</span>(pred,y)<span class="sc">%&gt;%</span> broom<span class="sc">::</span><span class="fu">tidy</span>()</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(confu, <span class="at">file =</span> <span class="st">&quot;_supp/confu1.RData&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:fig1"></span>
<img src="img/img1.gif" alt="*Quá trình thay đổi biến target trong 30 iterations*"  />
<p class="caption">
Figure 3.1: <em>Quá trình thay đổi biến target trong 30 iterations</em>
</p>
</div>
<p>Phương pháp EM đã có package sẵn trong <code>R</code> để chạy với tốc độ khá nhanh, tuy nhiên với mục đích học và hiểu, trong bài này ta sẽ tự code thủ công.</p>
<p>Như trong <span style="color: #424242; font-size: 18px;"><em>Fig.</em></span> <a href="#fig:fig1">3.1</a> ta thấy rằng qua mỗi lần iteration, thì các observations lại thay đổi qua lại trong 3 cụm. Càng về cuối thì sự thay đổi này càng ít đi và đến cuối cùng thì dường như không còn thay đổi nữa.</p>
<p>Sau 30 lần chạy, ta sẽ có kết quả được thể hiện như trong bảng confusion <span style="color: #424242; font-size: 18px;"><em>Fig.</em></span> <a href="#fig:fig2">3.2</a> bên dưới</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;_supp/confu1.RData&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(confu,<span class="at">target_col =</span> <span class="st">&quot;y&quot;</span>, <span class="at">prediction_col =</span> <span class="st">&quot;pred&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">counts_col =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:fig2"></span>
<img src="3DS-III-03_em-with-clustering-problem_files/figure-html/fig2-1.png" alt="*Bảng confusion thể hiện tỉ lệ dự đoán đúng và sai theo trong từng trường hợp.*" width="672" />
<p class="caption">
Figure 3.2: <em>Bảng confusion thể hiện tỉ lệ dự đoán đúng và sai theo trong từng trường hợp.</em>
</p>
</div>
<p>Như vậy tỉ lệ dự đoán chính xác lên đến 92.7% chính là tồng phần trăm thể hiện trên đường chéo của <span style="color: #424242; font-size: 18px;"><em>Fig.</em></span> <a href="#fig:fig2">3.2</a>.</p>
<!-- ----------------------------------------------------------------------------- -->
<!-- # _References_ {-} -->
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
